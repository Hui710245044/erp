<template>
    <div>
        <page-dialog :title="action.title"
                     size="small"
                     v-model="visible"
                     @open="open"
                     :close-on-click-modal="false">
            <el-form :model="serverData">
                <el-form-item label="服务器名：" label-width="100px" required>
                    <el-col :span="12">
                        <el-input v-model="serverData.name"></el-input>
                    </el-col>
                </el-form-item>
                <el-form-item label="IP地址：" label-width="100px" required>
                    <el-col :span="12">
                        <el-input v-model="serverData.ip"></el-input>
                    </el-col>
                </el-form-item>
                <el-form-item label="MAC地址：" label-width="100px" required>
                    <el-col :span="12">
                        <el-input v-model="serverData.mac"></el-input>
                    </el-col>
                </el-form-item>
                <el-form-item label="域名：" label-width="100px">
                    <el-col :span="12">
                        <el-input v-model="serverData.domain"></el-input>
                    </el-col>
                </el-form-item>
                <el-form-item label="类型：" label-width="100px">
                    <el-col :span="12">
                        <el-select v-model="serverData.type">
                            <el-option
                                    v-for="item in typeList"
                                    :key="item.value"
                                    :label="item.label"
                                    :value="item.value">
                            </el-option>
                        </el-select>
                    </el-col>
                </el-form-item>
                <el-form-item label="管理员名称：" label-width="100px">
                    <el-col :span="12">
                        <el-input v-model="serverData.admin"></el-input>
                    </el-col>
                </el-form-item>
                <el-form-item label="密码：" label-width="100px">
                    <el-col :span="12">
                        <el-input v-model="serverData.password" type="password"></el-input>
                    </el-col>
                </el-form-item>
                <el-form-item label="上报周期：" label-width="100px">
                    <el-col :span="12">
                        <integer-input v-model="serverData.reporting_cycle" :min="1"></integer-input>
                    </el-col>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <request-button @click="sure" req-key="addEditServer">确 定</request-button>
                <el-button size="mini" @click.native="visible = false">取 消</el-button>
            </div>
        </page-dialog>
    </div>
</template>
<style lang="stylus">

</style>
<script>
    import {api_add_server, api_update_server} from '../../../api/server-management'
    export default {
        data(){
            return {
                visible: false,
                typeList:[
                    {label:'正常', value:0},
                    {label:'刷单', value:1},
                    {label:'云服务', value:2},

                ],
                oldPassword:''
            }
        },
        mounted(){
        },
        methods: {
            open(){
                this.oldPassword = window.clone(this.serverData.password);
            },
            sure(){
                if(this.serverData.mac.indexOf(':') !== -1){
                    let arr = this.serverData.mac.split(':');
                    this.serverData.mac = arr.join('-');
                }
                this.serverData.mac = this.serverData.mac.toUpperCase();
                let temp =  /[A-F\d]{2}-[A-F\d]{2}-[A-F\d]{2}-[A-F\d]{2}-[A-F\d]{2}-[A-F\d]{2}/;
                let exp=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;
                if(exp.test(this.serverData.ip)){
                    if(temp.test(this.serverData.mac)){
                        let data = {
                            id: this.serverData.id,
                            name: this.serverData.name,
                            ip: this.serverData.ip,
                            mac: this.serverData.mac,
                            domain:this.serverData.domain,
                            type: this.serverData.type,
                            admin: this.serverData.admin,
                            password: this.serverData.password,
                            reporting_cycle: this.serverData.reporting_cycle
                        };
                        if(this.action.type === 'add'){
                            delete data.id;
                            this.$http(api_add_server, data).then(res=>{
                                this.visible = false;
                                this.$message({type:"success",message:res.message||res});
                                this.$emit('add-update',res.id,data);
                            }).catch(code=>{
                                this.$message({type:"error",message:code.message || code});
                            }).finally(()=>{
                                setTimeout(() => {
                                    this.$reqKey('addEditServer', false);
                                }, 300)
                            });
                        } else if(this.action.type === 'edit'){
                            if(data.password === this.oldPassword){
                                delete data.password;
                            }
                            this.$http(api_update_server, this.serverData.id, data).then(res=>{
                                this.visible = false;
                                this.$message({type:"success",message:res.message||res});
                                this.$set(data,'create_time',this.serverData.create_time);
                                this.$emit('edit-update',this.serverData.id,data);
                            }).catch(code=>{
                                this.$message({type:"error",message:code.message || code});
                            }).finally(()=>{
                                setTimeout(() => {
                                    this.$reqKey('addEditServer', false);
                                }, 300)
                            });
                        }
                    } else {
                        this.$reqKey('addEditServer', false);
                        this.$message({type:"error",message:'请输入正确的MAC地址'})
                    }
                } else {
                    this.$reqKey('addEditServer', false);
                    this.$message({type:"error",message:'请输入正确的ip地址'})
                }
            }
        },
        computed: {},
        watch: {
            visible(val){
                this.$emit('input',val);
            },
            value(val) {
                this.visible = val;
            },
        },
        props: {
            value:{},
            serverData:{},
            action:{}
        },
        components: {
            pageDialog:require("../../../components/page-dialog.vue").default,
            requestButton:require('../../../global-components/request-button').default,
            integerInput:require('../../../components/integer-input.vue').default,
        },
    }
</script>
